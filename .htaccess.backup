# ICT Ticketportaal - Apache Security Configuration
# This file provides security hardening for Apache web servers

# ============================================
# GENERAL SECURITY SETTINGS
# ============================================

# Disable directory browsing
Options -Indexes

# Disable server signature
ServerSignature Off

# Follow symbolic links (required for some frameworks)
Options +FollowSymLinks

# Disable MultiViews to prevent content negotiation issues
Options -MultiViews

# ============================================
# HTTPS REDIRECT
# ============================================

# Redirect all HTTP traffic to HTTPS
# Comment out these lines if you're in development without SSL
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Redirect to HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Redirect www to non-www (optional - adjust as needed)
    # RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    # RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
</IfModule>

# ============================================
# SECURITY HEADERS
# ============================================

<IfModule mod_headers.c>
    # Prevent clickjacking attacks
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Enable XSS protection in browsers
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (adjust as needed for your application)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self'; frame-ancestors 'self';"
    
    # Strict Transport Security (HSTS) - only enable after confirming HTTPS works
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Permissions Policy (formerly Feature Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Remove server information
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ============================================
# FILE ACCESS PROTECTION
# ============================================

# Protect sensitive files and directories
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Protect configuration files
<FilesMatch "\.(ini|log|conf|sql|md)$">
    Require all denied
</FilesMatch>

# Protect specific directories
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Deny access to config directory
    RewriteRule ^config/ - [F,L]
    
    # Deny access to classes directory
    RewriteRule ^classes/ - [F,L]
    
    # Deny access to includes directory
    RewriteRule ^includes/ - [F,L]
    
    # Deny access to logs directory
    RewriteRule ^logs/ - [F,L]
    
    # Deny access to database directory
    RewriteRule ^database/ - [F,L]
</IfModule>

# ============================================
# PHP SECURITY SETTINGS
# ============================================

<IfModule mod_php7.c>
    # Disable dangerous PHP functions
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log logs/php_errors.log
    
    # Disable file uploads in specific directories (if needed)
    # php_flag file_uploads Off
    
    # Set maximum execution time
    php_value max_execution_time 30
    
    # Set maximum input time
    php_value max_input_time 60
    
    # Set memory limit
    php_value memory_limit 128M
    
    # Set maximum post size
    php_value post_max_size 12M
    
    # Set maximum upload file size
    php_value upload_max_filesize 10M
</IfModule>

# ============================================
# FILE UPLOAD PROTECTION
# ============================================

# Prevent execution of PHP files in upload directories
<Directory "uploads">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
    
    # Disable PHP execution
    php_flag engine off
    
    # Set proper MIME types
    AddType text/plain .php .php3 .php4 .php5 .phtml
</Directory>

# ============================================
# COMPRESSION
# ============================================

# Enable GZIP compression for better performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# ============================================
# CACHING
# ============================================

# Set cache control for static assets
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML and other dynamic content
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ============================================
# ERROR PAGES
# ============================================

# Custom error pages (create these files if needed)
# ErrorDocument 400 /error/400.html
# ErrorDocument 401 /error/401.html
# ErrorDocument 403 /error/403.html
# ErrorDocument 404 /error/404.html
# ErrorDocument 500 /error/500.html

# ============================================
# ADDITIONAL SECURITY
# ============================================

# Disable ETags (can leak inode information)
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# Limit request methods to only what's needed
<LimitExcept GET POST HEAD>
    Require all denied
</LimitExcept>

# Protect against DOS attacks by limiting request size
LimitRequestBody 10485760

# ============================================
# URL REWRITING (if needed for clean URLs)
# ============================================

# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteBase /
#     
#     # Add your custom rewrite rules here
# </IfModule>

